name: Smart Auto Recovery (DISABLED - ARM64)

# Disabled because we're now using ARM64 architecture
# The workflow was designed for x86_64 Docker cache issues
on:
  workflow_dispatch: # Only allow manual trigger

jobs:
  smart-recovery:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Check for architecture failures
        id: check-failure
        run: |
          # Check for Runtime.InvalidEntrypoint errors in last 20 minutes
          LOG_OUTPUT=$(aws logs filter-log-events \
            --log-group-name "/aws/lambda/CamplyStack-prod-LambdaFunction9233991D-ioXwYaVrK7uB" \
            --start-time $(date -d '20 minutes ago' +%s)000 \
            --filter-pattern "Runtime.InvalidEntrypoint" \
            --query 'events[*].[timestamp,message]' \
            --output text)
          
          ERRORS=$(echo "$LOG_OUTPUT" | wc -l)
          
          if [ -n "$LOG_OUTPUT" ] && [ "$ERRORS" -gt 0 ]; then
            echo "üö® Architecture failure detected in last 20 minutes"
            echo "needs_recovery=true" >> $GITHUB_OUTPUT
            
            # Get the most recent error message
            LATEST_ERROR=$(echo "$LOG_OUTPUT" | head -n 1)
            TIMESTAMP=$(echo "$LATEST_ERROR" | awk '{print $1}')
            MESSAGE=$(echo "$LATEST_ERROR" | cut -d' ' -f2-)
            
            # Convert timestamp to readable format
            READABLE_TIME=$(date -d @$((TIMESTAMP/1000)) -u '+%Y-%m-%d %H:%M:%S UTC')
            
            # Save error details (use delimiter to handle multiline)
            echo "error_time<<EOF" >> $GITHUB_OUTPUT
            echo "$READABLE_TIME" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "error_count=$ERRORS" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No architecture failures detected"
            echo "needs_recovery=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check-failure.outputs.needs_recovery == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-failure.outputs.needs_recovery == 'true'
        run: npm ci

      - name: Clean Docker and redeploy
        if: steps.check-failure.outputs.needs_recovery == 'true'
        run: |
          echo "üîß Cleaning Docker cache and redeploying..."
          docker system prune -af --volumes
          npm run build
          # Use buildx for ARM64 cross-compilation on x86_64 GitHub runners
          docker buildx create --use --name arm-builder || docker buildx use arm-builder
          npx cdk deploy --all -c env=prod --require-approval never

      - name: Verify recovery
        if: steps.check-failure.outputs.needs_recovery == 'true'
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to complete..."
          sleep 30
          aws lambda invoke --function-name CamplyStack-prod-LambdaFunction9233991D-ioXwYaVrK7uB response.json
          if [ $? -eq 0 ]; then
            echo "‚úÖ Recovery successful - Lambda responding"
          else
            echo "‚ùå Recovery failed - Lambda still not responding"
            exit 1
          fi

      - name: Get timestamp
        if: steps.check-failure.outputs.needs_recovery == 'true'
        id: timestamp
        run: echo "time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
      - name: Send recovery notification
        if: steps.check-failure.outputs.needs_recovery == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üîß Camply Auto-Recovery Completed"
          body: |
            üö® Your Camply system detected Docker architecture failures and automatically recovered!
            
            üìä Failure Details:
            - Error count: ${{ steps.check-failure.outputs.error_count }}
            - First detected: ${{ steps.check-failure.outputs.error_time }}
            
            üìù Error Message:
            ${{ steps.check-failure.outputs.error_message }}
            
            ‚úÖ Recovery Actions:
            - Docker cache cleared
            - Lambda function redeployed
            - System verified working
            
            Recovery completed at: ${{ steps.timestamp.outputs.time }}
            
            Your campsite monitoring is now running normally again.
          to: ${{ secrets.EMAIL_USERNAME }}
          from: ${{ secrets.EMAIL_FROM_ADDRESS }}
